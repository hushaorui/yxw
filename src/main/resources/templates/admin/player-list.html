<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>DIY作品</title>

    <link rel="stylesheet" href="../../static/bootstrap/css/bootstrap.min.css" th:href="@{/bootstrap/css/bootstrap.min.css}">
    <link rel="stylesheet" href="../../static/bootstrap/css/common.css" th:href="@{/bootstrap/css/common.css}">
    <link rel="stylesheet" href="../../static/bootstrap/css/toastr.css" th:href="@{/bootstrap/css/toastr.css}">
    <script src="../../static/bootstrap/js/jquery.min.2.1.1.js" th:src="@{/bootstrap/js/jquery.min.2.1.1.js}"></script>
    <script src="../../static/bootstrap/js/bootstrap.min.js" th:src="@{/bootstrap/js/bootstrap.min.js}"></script>
    <script src="../../static/bootstrap/js/common.js" th:src="@{/bootstrap/js/common.js}"></script>
    <script src="../../static/bootstrap/js/toastr.min.js" th:src="@{/bootstrap/js/toastr.min.js}"></script>
    <style>
        .player-tr:hover {
            background-color: #5bc0de;
        }
    </style>
</head>
<body>
<div style="margin:10px;">
    <ol class="breadcrumb">
        <li><a href="#">主页</a></li>
        <li><a href="#">用户管理</a></li>
        <li class="active">用户列表</li>
    </ol>
    <button class="btn btn-danger" onclick="showBatchDeletePlayerModal()">批量删除</button>
    <form id="player-list-form" action="/admin/player-list" method="post">
    <table class="table">
        <caption>
            用户列表&nbsp;&nbsp;&nbsp;&nbsp; 总数：[<span id="player-total-count" class="font-blue" th:text="${pageBean.totalCount}"></span>]
            每页显示数量：
            <select id="player-page-select" class="form-select-button" name="pageSize">
                <option th:each="item:${pageSizes}" th:value="${item.key}" th:text="${item.value}" th:selected="${item.key eq pageBean.pageSize}"></option>
            </select>
            共 <span class="font-blue" th:text="${pageBean.totalPage}"></span> 页
            <input type="hidden" name="pageNum" id="pageNum" />
        </caption>
        <thead>
            <th><input type="checkbox" id="check-all" /></th>
            <th>序号</th>
            <th>ID</th>
            <th>用户名</th>
            <th>密码</th>
            <th>管理员</th>
            <th>创建时间</th>
            <th>最后登录时间</th>
            <th>操作</th>
        </thead>
        <tbody th:each="player,stat:${pageBean.pageList}">
        <tr class="player-tr">
            <td><input type="checkbox" class="player-checkbox" th:idData="${player.id}" /></td>
            <td th:text="${stat.count}"></td>
            <td class="player-id-td" th:text="${player.id}"></td>
            <td class="player-username-td" th:text="${player.username}"></td>
            <td class="player-password-td" th:text="${player.password}"></td>
            <td class="player-admin-td" th:text="${player.admin}"></td>
            <td th:text="${#dates.format(player.createTime,'yyyy-MM-dd HH:mm:ss')}"></td>
            <td th:text="${#dates.format(player.lastLoginTime,'yyyy-MM-dd HH:mm:ss')}"></td>
            <td><a class="btn btn-success btn-xs" onclick="showEditPlayerModal(this)" >添加</a></td>
            <td><a class="btn btn-danger btn-xs" th:onclick="'showDeletePlayerModal(' + ${player.id} + ')'">删除</a></td>
        </tr>
        </tbody>
    </table>
    <ul class="pagination">
        <li>
            <div class="input-group">
                <input type="text" class="form-control" id="go-input"  onkeyup="this.value=this.value.replace(/\D/g,'')">
                <span class="input-group-btn">
                    <button class="btn btn-default" type="button" id="go-btn">GO!</button>
                </span>
            </div>
        </li>
        <li th:each="otherPage,stat:${pageBean.otherPages}"
            th:class="${otherPage.value1 == pageBean.currentPage and otherPage.value1+'' eq otherPage.value2}? 'active' : ''" >

            <a href="#" th:text="${otherPage.value2}"
               th:onclick="'requestPage(' + ${otherPage.value1} + ')'"></a>
        </li>
    </ul>
    </form>

    <!-- 删除玩家模态框（Modal） -->
    <div class="modal fade" id="deletePlayerModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="deleteModalLabel">请确认</h4>
                </div>
                <div class="modal-body">是否删除ID为 <span id="delete-id-span"></span> 的用户？</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="deletePlayer()" >确认</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <!-- 编辑玩家模态框（Modal） -->
    <div class="modal fade" id="editPlayerModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="editModalLabel">编辑</h4>
                </div>
                <form id="player-update-form" class="form-horizontal" role="form">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">ID</label>
                        <div class="col-sm-8">
                            <p id="player-id-p" class="form-control-static"></p>
                            <input id="player-id-input" type="hidden" name="id" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newUsername" class="col-sm-2 control-label">用户名</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" id="newUsername" name="username" placeholder="请输入密码">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newPassword" class="col-sm-2 control-label">密码</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" id="newPassword" name="password" placeholder="请输入密码">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newAdmin" class="col-sm-2 control-label"> 是否管理员</label>
                        <div class="col-sm-8">
                            <select id="newAdmin" class="form-control" name="admin">
                                <option value="">请选择...</option>
                                <option value="false">不是</option>
                                <option value="true">是</option>
                            </select>
                        </div>
                    </div>
                </form>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="updatePlayer()" >提交</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
</div>
</body>
<script>
    // 删除玩家
    function deletePlayer() {
        var ids = $("#delete-id-span").html();
        if ("" === ids) {
            return;
        }
        $.get("/admin/player-delete", {"ids" : ids}, function (result) {
            toastr[result.result](result.message);
        }, "json");
    }
    //提交玩家修改
    function updatePlayer() {
        // 校验
        var username = $("#newUsername").val();
        if (username === "") {
            toastr.warning("用户名不可为空！");
        }
        if (! /[\u4e00-\u9fa5_a-zA-Z0-9]{1,36}/.test(username)) {
            toastr.warning("用户名只能由汉字、字母、数字组成，长度不超过36个字符！");
            return;
        }
        var password = $("#newPassword").val();
        if (password === "") {
            toastr.warning("密码不可为空！");
        }
        if (! /[\u4e00-\u9fa5_a-zA-Z0-9]{1,36}/.test(password)) {
            toastr.warning("密码只能由汉字、字母、数字组成，长度不超过36个字符！");
            return;
        }
        var admin = $("#newAdmin").val();
        if (admin === "") {
            toastr.warning("请选择是否为管理员！");
        }
        // 提交
        $.post("/admin/player-update", $("#player-update-form").serialize(), function (result) {
            toastr[result.result](result.message);
        }, "json");
    }
    // 显示编辑玩家的确认框
    function showEditPlayerModal(aElement) {
        var id = $(aElement).parent().siblings(".player-id-td").html();
        var username = $(aElement).parent().siblings(".player-username-td").html();
        var password = $(aElement).parent().siblings(".player-password-td").html();
        var admin = $(aElement).parent().siblings(".player-admin-td").html();
        //console.log(id + " " + username + " " + password + " " + admin);
        $("#player-id-p").html(id);
        $("#player-id-input").val(id);
        $("#newUsername").val(username);
        $("#newPassword").val(password);
        $("#newAdmin").val(admin);
        $("#editPlayerModal").modal("show");
    }
    // 显示删除玩家的确认框
    function showDeletePlayerModal(id) {
        $("#delete-id-span").html(id);
        $("#deletePlayerModal").modal("show");
    }
    // 显示批量删除玩家的确认框
    function showBatchDeletePlayerModal() {
        var ids = "";
        // 遍历所有被选中的行
        $.each($(".player-checkbox[type=checkbox]:checked"), function (index, item) {
            ids += "," + $(this).attr("idData");
        });
        if (ids === "") {
            toastr.warning("您还未勾选任何玩家！");
            return;
        }
        $("#delete-id-span").html(ids);
        $("#deletePlayerModal").modal("show");
    }
    // 请求其他页的数据
    function requestPage(pageNum) {
        $("#pageNum").val(pageNum);
        var jsonData = $("#player-list-form").serialize();
        getContentHtml('/admin/player-list', true, jsonData);
    }
    $(function() {
        // 全选与全不选
        $("#check-all").click(function() {
            $(".player-checkbox").prop("checked", this.checked); // this指代的你当前选择的这个元素的JS对象
        });
        // GO 直接请求某一页的数据
        $("#go-btn").click(function() {
            var pageNum = $("#go-input").val();
            if ("" === pageNum) {
                return;
            }
            requestPage(pageNum);
        });
    })
</script>
</html>